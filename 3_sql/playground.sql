/**

  This file stores codes used for administering transfer jobs
  Author: Wayne Zhang
  Date: April 7th, 2020

  **/

/*
Database Status:
    Complete with all data:
    - All the look up tables
    - Location
    - Product
    Ready to populate:
    - Machine
    - Setting
    Waiting:
    - Mac_Prod
    - Mac_Setting
   */

-- Product Table
    -- creates working copy
/*CREATE TABLE tempProduct (
    RowID INT IDENTITY PRIMARY KEY ,
    ProductType VARCHAR(100),
    AppVersion VARCHAR(100),
    EngVersion VARCHAR(100),
    AvSigVersion VARCHAR(100),
    AvStateID VARCHAR(100)
)
-- TRUNCATE TABLE tempProduct
INSERT INTO tempProduct (ProductType, AppVersion, EngVersion, AvSigVersion, AvStateID)
SELECT DISTINCT ProductName, AppVersion, EngineVersion, AvSigVersion, AVProductStatesIdentifier
FROM tblWorkingCopy
SELECT COUNT(*) FROM tempProduct

-- TRUNCATE TABLE Product
INSERT INTO Product (PTypeID, AppVersion, EngVersion, AvSigVersion, AvStateID)
SELECT (CASE
        WHEN ProductName = 'fep' THEN 1
            WHEN ProductName = 'mse' THEN 2
            WHEN ProductName = 'mseprerelease' THEN 3
            WHEN ProductName = 'scep' THEN 4
            WHEN ProductName = 'win8defender' THEN 5
            ELSE 6 END) AS PTypeID, AppVersion, EngineVersion, AvSigVersion, AVProductStatesIdentifier
       FROM tblWorkingCopyLite

-- Machine Table
    -- Creates working copy
CREATE TABLE tempMachine (
    RowID INT IDENTITY PRIMARY KEY ,
    DeviceFamily VARCHAR(50),
    OrgTag VARCHAR(50),
    CityCode VARCHAR(50),
    RegionCode VARCHAR(50),
    CountryCode VARCHAR(50),
    GeoCode VARCHAR(50),
    FirmwareManu VARCHAR(50),
    FirmVerID VARCHAR(50),
    MachineTag VARCHAR(50)
)
-- TRUNCATE TABLE tempMachine
INSERT INTO tempMachine (DeviceFamily, OrgTag, CityCode, RegionCode, CountryCode, GeoCode, FirmwareManu, FirmVerID, MachineTag)
SELECT Census_DeviceFamily, OrganizationIdentifier, CityIdentifier, GeoNameIdentifier, CountryIdentifier, Wdft_RegionIdentifier,
                Census_FirmwareManufacturerIdentifier, Census_FirmwareVersionIdentifier, MachineIdentifier FROM tblWorkingCopy
DECLARE @run1 INT = (
    SELECT COUNT(*) FROM (SELECT * FROM tempMachine) AS temp1
    )
EXEC yz273_pWrapperMachine @run = @run1

SELECT COUNT(*) FROM Machine

    -- Machine Product
SELECT COUNT(*) FROM (
                     SELECT DISTINCT * FROM Product
                         ) AS TEMP1

SELECT COUNT(*) FROM Machine

SELECT TOP 500 * FROM dbo.[1]

-- Design an alternative procedure to process each numbered table;

SELECT TOP 500 * FROM dbo.[1] ORDER BY RowID ASC

DROP TABLE temp1
SELECT * INTO temp1
FROM dbo.[1]

-- Alternative Wrapper draft
DECLARE @run INT = (SELECT COUNT(*) FROM temp1)
DECLARE @run INT = 30
WHILE @run > 0
	BEGIN
		DECLARE @runMachine VARCHAR(100),
				@runSTName VARCHAR(100),
				@runSName VARCHAR(100)
		SELECT @runMachine = MachineIdentifier,
				@runSTName = Setting,
				@runSName = SettingName
		FROM temp1 WHERE RowID = @run
		EXEC yz273_pInsertMachineSetting
		@newMachineTag = @runMachine,
		@newSTName = @runSTName,
		@newSName = @runSName
		SET @run = @run - 1
	END
-- This method takes ~1s each row,
-- Greg's method takes 1min for 100 rows
	-- somehow faster (1.6 row / s*/


-- Verify result
SELECT COUNT(*) FROM Machine_Setting
SELECT TOP 5000 * FROM Machine_Setting
-- TRUNCATE TABLE Machine_Setting
CREATE TABLE MiscSetting (
    RowID INT IDENTITY PRIMARY KEY,
    SettingName VARCHAR(100)
)
INSERT INTO MiscSetting (SettingName)
VALUES ('RtpStateBitfield'),
('AVProductsInstalled'),
('AVProductsEnabled'),
('LocaleEnglishNameIdentifier'),
('Platform'),
('OsVer'),
('OsBuild'),
('OsSuite'),
('OsPlatformSubRelease'),
('OsBuildLab'),
('SkuEdition'),
('PuaMode'),
('SmartScreen'),
('UacLuaenable'),
('Census_MDC2FormFactor'),
('Census_OEMNameIdentifier'),
('Census_OEMModelIdentifier'),
('Census_PrimaryDiskTotalCapacity'),
('Census_PrimaryDiskTypeName'),
('Census_SystemVolumeTotalCapacity'),
('Census_PowerPlatformRoleName'),
('Census_OSVersion'),
('Census_OSArchitecture'),
('Census_OSBranch'),
('Census_OSBuildNumber'),
('Census_OSBuildRevision'),
('Census_OSEdition'),
('Census_OSSkuName'),
('Census_OSInstallTypeName'),
('Census_OSInstallLanguageIdentifier'),
('Census_OSUILocaleIdentifier'),
('Census_OSWUAutoUpdateOptionsName'),
('Census_GenuineStateName'),
('Census_ActivationChannel'),
('Census_FlightRing')

-- May 8th
Select * FROM Setting_Type WHERE SettingTypeName LIKE '%virus%'

-- May 11th
EXEC RunRatioTest2Combination '17914', 'Census_OSBuildRevision', '10.0.10240.17914', 'Census_OSVersion'

Declare @Temp varchar(50) = '''1.273.1501.0'''
Declare @TempName varchar(50) = 'AvSigVersion'
		Declare @Count int,
        @Query nvarchar(300),
        @Condition  nvarchar(100)
SET @condition = @TempName + ' = ' + @Temp
SET @query = 'Select @Count = COUNT(1) FROM Product WHERE ' + @Condition
EXECUTE sp_executeSQL @query, N'@Count INT OUTPUT', @Count OUTPUT


-- May 15th, Wayne
SELECT TOP 300 * FROM Test
JOIN Test_Setting TS on Test.TestID = TS.TestID
JOIN Setting S on TS.SettingID = S.SettingID
JOIN Setting_Type ST on S.SettingTypeID = ST.SettingTypeID
ORDER BY Ratio DESC

SELECT COUNT(*) FROM Test
ALTER TABLE Machine ADD FOREIGN KEY (LocationID) REFERENCES Location(LocationID)


/* it pulls the machines where the avsig and avstate = parameters
   see how many machines in there have detection
   Test value:
   '63682', '1.273.1501.0'
   */

/*
DROP queryMacProd
CREATE TABLE queryMacProd (
    RowID INT IDENTITY PRIMARY KEY,
    MachineID INT FOREIGN KEY REFERENCES Machine(MachineID),
    ProductID INT FOREIGN KEY REFERENCES Product(ProdID)
)

CREATE -- ALTER
    PROC yz273_pAvSig_State
@sig VARCHAR(50),
@state VARCHAR(50)
AS
    BEGIN
        -- selects all machine that has the two parameters
        DECLARE @base INT = (
            SELECT COUNT(*) FROM (
                SELECT mp.MachineID, mp.ProdID
                FROM Machine_Prod mp
                JOIN Machine M on mp.MachineID = M.MachineID
                JOIN Product P on mp.ProdID = P.ProdID
                JOIN Machine_Setting MS on M.MachineID = MS.MachineID
                JOIN Setting S on MS.SettingID = S.SettingID
                WHERE P.AvSigVersion = @sig
                    AND P.AvStateID = @state
                ) AS temp1)
        DECLARE @detectionID INT = (Select S.SettingID FROM Setting S
							JOIN Setting_Type ST on S.SettingTypeID = ST.SettingTypeID
							Where S.SettingName = '1' AND ST.SettingTypeName = 'hasDetections')
        DECLARE @hasDetection INT = (
            SELECT COUNT(*) FROM (
                SELECT mp.MachineID, mp.ProdID
                FROM Machine_Prod mp
                JOIN Product P2 ON mp.ProdID = P2.ProdID
                JOIN Machine M2 on mp.MachineID = M2.MachineID
                JOIN Machine_Setting MS2 on M2.MachineID = MS2.MachineID
                JOIN Setting S2 on MS2.SettingID = S2.SettingID
                WHERE S2.SettingID = @detectionID
                AND P2.AvSigVersion = @sig
                AND P2.AvStateID = @state
                                     ) AS temp2
            )
        SELECT @hasDetection / @base
    end

EXEC yz273_pAvSig_State @sig = '1.273.1501.0', @state = '63682'*/

select * from Test t
join Test_Setting TS on t.TestID = TS.TestID
/*create table TestPairs (
    TestPairID int identity primary key,
    TestID int foreign key references Test (TestID),
    Field_one varchar(100),
    Value_one varchar(100),
    Field_two varchar(100),
    Value_two varchar(100),
    TotalElements int,
    NumberDetection int,
    Ration numeric(7,2)
)*/
-- drop table TestPairs


/*select TestProductID, tc.TestID as 'TestID', TypeDescription as 'FieldName', VariableName as 'FieldValue',
       TotalElements, NumberOfDetections, Ratio
into tblTestProduct
from Test_Combination tc
join Test T on tc.TestID = T.TestID
go

select PrimaryID as 'TestSettingID', ST.SettingTypeName as 'FieldName', ts.SettingID as 'FieldValue', TotalElements, NumberOfDetections, Ratio
into tblTestSetting
from Test_Setting ts
join Test T on ts.TestID = T.TestID
join Setting S on ts.SettingID = S.SettingID
join Setting_Type ST on S.SettingTypeID = ST.SettingTypeID
go*/

create -- alter
    proc pCreatetblTestTables as
    begin
        drop table tblTestProduct
        drop table tblTestSetting
        select TestProductID, tc.TestID as 'TestID', TypeDescription as 'FieldName', VariableName as 'FieldValue',
       TotalElements, NumberOfDetections, Ratio
        into tblTestProduct
        from Test_Combination tc
        join Test T on tc.TestID = T.TestID;
        --
        select PrimaryID as 'TestSettingID', T.TestID as 'TestID', ST.SettingTypeName as 'FieldName', ts.SettingID as 'FieldValue', TotalElements, NumberOfDetections, Ratio
        into tblTestSetting
        from Test_Setting ts
        join Test T on ts.TestID = T.TestID
        join Setting S on ts.SettingID = S.SettingID
        join Setting_Type ST on S.SettingTypeID = ST.SettingTypeID;
    end

select * from tblTestProduct
-- target table: TestPairs
--     TestID int foreign key references Test (TestID),
--     Field_one
--     Value_one
--     Field_two
--     Value_two
--     TotalElements
--     NumberDetection
--     Ration

    -- for Test_Product
/*while (select count(*) From tblTestProduct) > 0 begin
    declare @firstIndex int = (select min(TestProductID) from tblTestProduct)
    declare @secondIndex int = @firstIndex + 1
    declare @newTestID int = (select TestID from tblTestProduct where TestProductID = @firstIndex)
    declare @newField1 varchar(100) = (select FieldName from tblTestProduct where TestProductID = @firstIndex)
    declare @newValue1 varchar(100) = (select FieldValue from tblTestProduct where TestProductID = @firstIndex)
    declare @newField2 varchar(100) = (select FieldName from tblTestProduct where TestProductID = @secondIndex)
    declare @newValue2 varchar(100) = (select FieldValue from tblTestProduct where TestProductID = @secondIndex)
    declare @newTotal int = (select TotalElements from tblTestProduct where TestProductID = @firstIndex)
    declare @newDetection int = (select NumberOfDetections from tblTestProduct where TestProductID = @firstIndex)
    declare @newRatio int = (select Ratio from tblTestProduct where TestProductID = @firstIndex)
    insert into reportTestProduct (TestID, Field_one, Value_one, Field_two, Value_two, TotalElements, NumberDetection, Ration)
    values(@newTestID, @newField1, @newValue1, @newField2, @newValue2, @newTotal, @newDetection, @newRatio)
    delete from tblTestProduct where TestProductID = @firstIndex
    delete from tblTestProduct where TestProductID = @secondIndex
end*/
exec pCreatetblTestTables

select * from tblTestSetting order by TestID



drop table tblTestSetting
select PrimaryID, T.TestID as 'TestID', ST.SettingTypeName as 'FieldName', ts.SettingID as 'FieldValue', TotalElements, NumberOfDetections, Ratio

-- check source table: TestPairs
select * from TestPairs
where TestID = 1364

select * from reportTestSetting

/****
  Note on TestID 1364:
  The settings involved are:
    - SmartScreen, 1452
    - RtpStateBitfield, 11
    - OsSuite,460
  Because 3 settings were involved, it could not fit in the visualization;
    Total occurrence: 3840
    Detection count: 3395
    Infected ratio: 88.41

  -- Delete the entry with TestID 1364 and proceed with report table;
  delete from TestPairs where TestID = 1364
  -- Check that the TestPair table has entries formed in pairs:
    select distinct CountOfID from (
                  select TestID, count(TestID) as 'CountOfID'
                  from TestPairs
                  group by TestID
              ) as temp1
  -- should return only 2
  ****/
while (select count(*) From TestPairs) > 0 begin
    declare @firstIndex int = (select min(PairID) from TestPairs)
    declare @secondIndex int = @firstIndex + 1
    declare @newTestID int = (select TestID from TestPairs where PairID = @firstIndex)
    declare @newField1 varchar(100) = (select Setting from TestPairs where PairID = @firstIndex)
    declare @newValue1 varchar(100) = (select Value from TestPairs where PairID = @firstIndex)
    declare @newField2 varchar(100) = (select Setting from TestPairs where PairID = @secondIndex)
    declare @newValue2 varchar(100) = (select Value from TestPairs where PairID = @secondIndex)
    declare @newTotal int = (select Total from TestPairs where PairID = @firstIndex)
    declare @newDetection int = (select Detection from TestPairs where PairID = @firstIndex)
    declare @newRatio int = (select Ratio from TestPairs where PairID = @firstIndex)
    insert into reportTestSetting (TestID, Setting1, Value1, Setting2, Value2, Total, Detection, Ratio)
    values(@newTestID, @newField1, @newValue1, @newField2, @newValue2, @newTotal, @newDetection, @newRatio)
    delete from TestPairs where PairID = @firstIndex
    delete from TestPairs where PairID = @secondIndex
end
select * from reportTestSetting order by Total desc

/** Further preparation for visualization: other metrics **/
select * from reportTestSetting order by Ratio desc

select * from Test t
join Test_SettingProduct TSP on t.TestID = TSP.TestID

select T.TestID, P.ProductType as 'ProductTypeName', P.ProductName,
       P.SettingType as 'SettingTypeName', P.SettingName,
       T.TotalElements as 'Total', T.NumberOfDetections as 'Detection', T.Ratio
into reportProductSetting
from Test T
join Test_SettingProduct P on T.TestID = P.TestID
order by T.TestID

