/*
	Machine table look ups:
	- Device
	- Organization
	- City
	- Firmware
*/
GO
CREATE PROC yz273_pGetDeviceID
@DeviceFamily VARCHAR(50),
@DeviceID INT OUTPUT
AS SET @DeviceID = (SELECT DeviceID FROM Device WHERE DeviceFamily = @DeviceFamily)
GO -- SELECT * FROM Device

CREATE PROC yz273_pGetOrgID
@OrgTag VARCHAR(50),
@OrgID INT OUTPUT
AS SET @OrgID = (SELECT OrgID FROM Organization WHERE OrgTag = @OrgTag)
GO -- SELECT * FROM Organization

CREATE PROC yz273_pGetFirmwareID
@FirmwareManuIdent VARCHAR(50),
@FirmwareVerID VARCHAR(50),
@FirmwareID INT OUTPUT
AS SET @FirmwareID = (SELECT FirmwareID FROM Firmware WHERE FirmManuIdent = @FirmwareManuIdent AND FirmVerID = @FirmwareVerID)
GO -- SELECT * FROM Firmware

CREATE -- ALTER
    PROC yz273_pGetLocationID
    @nCityCode VARCHAR(50),
    @nRegionCode VARCHAR(50),
    @nCountryCode VARCHAR(50),
    @nGeoCode VARCHAR(50),
    @LocationID INT OUTPUT
AS
    DECLARE @NRID INT, @NCoID INT, @NGID INT
    EXEC yz273_pGetRegionID @RegionCode = @nRegionCode, @RegionID = @NRID OUTPUT
    EXEC yz273_pGetCountryID @CountryCode = @nCountryCode, @CountryID = @NCoID OUTPUT
    EXEC yz273_pGetGeoID @GeoCode = @nGeoCode, @GeoID = @NGID OUTPUT
    SET @LocationID = (SELECT LocationID FROM Location
    WHERE CityCode = @nCityCode AND RegionID = @NRID AND CountryID = @NCoID AND GeoID = @NGID)
GO

    /* Insert procedure */
CREATE -- ALTER
    PROC yz273_pInsertMachine
@newDeviceFamily VARCHAR(50),
@newOrgTag VARCHAR(50),
@newCityCode VARCHAR(50),
@newRegionCode VARCHAR(50),
@newCountryCode VARCHAR(50),
@newGeoCode VARCHAR(50),
@newFirmwareManuTag VARCHAR(50),
@newFirmwareVerID VARCHAR(50),
@newMachineTag VARCHAR(50)
AS
    DECLARE @DID INT, @OID INT, @FID INT, @LID INT
    EXEC yz273_pGetDeviceID
    @DeviceFamily = @newDeviceFamily,
    @DeviceID = @DID OUTPUT
    EXEC yz273_pGetOrgID
    @OrgTag = @newOrgTag,
    @OrgID = @OID OUTPUT
    EXEC yz273_pGetFirmwareID
    @FirmwareManuIdent = @newFirmwareManuTag,
    @FirmwareVerID = @newFirmwareVerID,
    @FirmwareID = @FID OUTPUT
    EXEC yz273_pGetLocationID
    @nCityCode = @newCityCode,
    @nRegionCode = @newRegionCode,
    @nCountryCode = @newCountryCode,
    @nGeoCode = @newGeoCode,
    @LocationID = @LID OUTPUT
    INSERT INTO Machine (DeviceID, OrgID, LocationID, FirmwareID, MachineTag)
    VALUES(@DID, @OID, @LID, @FID, @newMachineTag)
    -- end of procedure
GO

    /* Wrapper */
CREATE -- ALTER
    PROC yz273_pWrapperMachine
@run INT
AS
    DECLARE @runDev VARCHAR(50), @runOrg VARCHAR(50), @runCity VARCHAR(50), @runReg VARCHAR(50), @runCountry VARCHAR(50),
        @runGeo VARCHAR(50), @runFirmManu VARCHAR(50), @runFirmVer VARCHAR(50), @runMachine VARCHAR(50)

    WHILE @run > 0 BEGIN
        SET @runDev = (SELECT DeviceFamily FROM tempMachine WHERE RowID = @run)
        SET @runOrg = (SELECT OrgTag FROM tempMachine WHERE RowID = @run)
        SET @runCity = (SELECT CityCode FROM tempMachine WHERE RowID = @run)
        SET @runReg = (SELECT RegionCode FROM tempMachine WHERE RowID = @run)
        SET @runCountry = (SELECT CountryCode FROM tempMachine WHERE RowID = @run)
        SET @runGeo = (SELECT GeoCode FROM tempMachine WHERE RowID = @run)
        SET @runFirmManu = (SELECT FirmwareManu FROM tempMachine WHERE RowID = @run)
        SET @runFirmVer = (SELECT FirmVerID FROM tempMachine WHERE RowID = @run)
        SET @runMachine = (SELECT MachineTag FROM tempMachine WHERE RowID = @run)
        SELECT @runDev = ..., @run2 = ... WHERE RowID = @run
        EXEC yz273_pInsertMachine
            @newDeviceFamily = @runDev,
            @newOrgTag = @runOrg,
            @newCityCode = @runCity,
            @newRegionCode = @runReg,
            @newCountryCode = @runCountry,
            @newGeoCode = @runGeo,
            @newFirmwareManuTag = @runFirmManu,
            @newFirmwareVerID = @runFirmVer,
            @newMachineTag = @runMachine
        DELETE FROM tempMachine WHERE RowID = @run
        SET @run = @run - 1
    end
GO

    /* Execution */
DECLARE @run1 INT = (
    SELECT COUNT(*) FROM (SELECT * FROM tempMachine) AS temp1
    )
EXEC yz273_pWrapperMachine @run = @run1

SELECT COUNT(*) FROM Machine