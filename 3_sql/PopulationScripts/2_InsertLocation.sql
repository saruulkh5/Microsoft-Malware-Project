/*
    Look up table for Location:
    CityID - City,
    RegionID - Region,
    CountryID - Country,
    GeoID - GeoLocation
*/
CREATE PROC yz273_pGetRegionID
@RegionCode VARCHAR(50),
@RegionID INT OUTPUT
AS
    BEGIN
        SET @RegionID = (SELECT RegionID FROM Region WHERE RegionCode = @RegionCode)
    end
GO
CREATE PROC yz273_pGetCountryID
@CountryCode VARCHAR(50),
@CountryID INT OUTPUT
AS
    BEGIN
        SET @CountryID = (SELECT CountryID FROM Country WHERE CountryCode = @CountryCode)
    end
GO
CREATE PROC yz273_pGetGeoID
@GeoCode VARCHAR(50),
@GeoID INT OUTPUT
AS
    BEGIN
        SET @GeoID = (SELECT GeoID FROM GeoLocation WHERE GeoCode = @GeoCode)
    end
GO
/*
    Actual Insertion Procedure
*/
CREATE -- ALTER
    PROC yz273_pInsertLocation
@newCityCode VARCHAR(50),
@newRegionCode VARCHAR(50),
@newCountryCode VARCHAR(50),
@newGeoCode VARCHAR(50)
AS
    DECLARE @RID INT, @CoID INT, @GID INT
    EXEC yz273_pGetRegionID @RegionCode = @newRegionCode, @RegionID = @RID OUTPUT
    IF @RID IS NULL BEGIN
        SET @RID = 1
    end
    EXEC yz273_pGetCountryID @CountryCode = @newCountryCode, @CountryID = @CoID OUTPUT
    IF @CoID IS NULL BEGIN
        SET @CoID = 1
    end
    EXEC yz273_pGetGeoID @GeoCode = @newGeoCode, @GeoID = @GID OUTPUT
    IF @GID IS NULL BEGIN
        SET @GID = 1
    end
    INSERT INTO Location (CityCode, RegionID, CountryID, GeoID)
    VALUES (@newCityCode, @RID, @CoID, @GID)
GO

    /* Wrapper */
CREATE -- ALTER
    PROC yz273_pWrapperLocation
AS
    DECLARE @runCityCode VARCHAR(50)
    DECLARE @runRegionCode VARCHAR(50)
    DECLARE @runCountryCode VARCHAR(50)
    DECLARE @runGeoCode VARCHAR(50)
    DECLARE @run INT = (SELECT COUNT(*) FROM tempLocation)
    -- Loop
    WHILE @run > 0
    BEGIN
        SET @runCityCode = (SELECT CityCode FROM tempLocation WHERE RowID = @run)
        SET @runRegionCode = (SELECT RegionCode FROM tempLocation WHERE RowID = @run)
        SET @runCountryCode = (SELECT CountryCode FROM tempLocation WHERE RowID = @run)
        SET @runGeoCode = (SELECT GeoCode FROM tempLocation WHERE RowID = @run)
        EXEC yz273_pInsertLocation
            @newCityCode = @runCityCode,
            @newRegionCode = @runRegionCode,
            @newCountryCode = @runCountryCode,
            @newGeoCode = @runGeoCode
        DELETE FROM tempLocation WHERE RowID = @run
        SET @run = @run - 1
    end
GO

-- DECLARE @run2 INT = (SELECT COUNT(*) FROM tblWorkingCopy)
EXEC yz273_pWrapperLocation
GO

-- Reset environment
-- TRUNCATE TABLE tempLocation
INSERT INTO tempLocation (CityCode, RegionCode, CountryCode, GeoCode)
SELECT DISTINCT CityIdentifier, GeoNameIdentifier, CountryIdentifier, Wdft_RegionIdentifier FROM tblWorkingCopy
SELECT COUNT(*) FROM tempLocation