/*******************************
    Prepares Product Table
    - Look up table:
    ProductType
        - ProductTypeID
*******************************/

select * from ProductType
-- Do not look up from Product Type, hard coded;

GO
CREATE -- ALTER
PROC yz273_pInsertProduct
@newTypeName VARCHAR(100),
@EngVersion VARCHAR(100),
@AppVersion VARCHAR(100),
@AvSigVersion VARCHAR(100),
@AvStateID VARCHAR(100)
AS
    DECLARE @newTypeID INT
    SET @newTypeID = (
        SELECT CASE
        WHEN @newTypeName = 'fep' THEN 1
            WHEN @newTypeName = 'mse' THEN 2
            WHEN @newTypeName = 'mseprerelease' THEN 3
            WHEN @newTypeName = 'scep' THEN 4
            WHEN @newTypeName = 'win8defender' THEN 5
            ELSE 6 END
        )
    INSERT INTO Product(PTypeID, EngVersion, AppVersion, AvSigVersion, AvStateID)
    VALUES(@newTypeID, @EngVersion, @AppVersion, @AvSigVersion, @AvStateID)
GO

GO
/*CREATE -- ALTER
PROC yz273_pWrapperProduct
    @run INT
AS
DECLARE @runProductName VARCHAR(100)
DECLARE @runEng VARCHAR(100)
DECLARE @runApp VARCHAR(100)
DECLARE @runAvSig VARCHAR(100)
DECLARE @runAvState VARCHAR(100)*/

/*
    Execution code
*/
DROP TABLE tempProduct
CREATE TABLE tempProduct (
    RowID INT IDENTITY PRIMARY KEY,
    PTypeName VARCHAR(100),
    AppVersion VARCHAR(100),
    EngVersion VARCHAR(100),
    AvSigVersion VARCHAR(100),
    AvStateID VARCHAR(100)
)
TRUNCATE TABLE tempProduct
INSERT INTO tempProduct (PTypeName, AppVersion, EngVersion, AvSigVersion, AvStateID)
SELECT DISTINCT ProductName, AppVersion, EngineVersion, AvSigVersion, AVProductStatesIdentifier
FROM tblWorkingCopy
SELECT COUNT(*) FROM tempProduct

    /* Wrapper */
DECLARE @run INT = (SELECT COUNT(*) FROM tempProduct)
WHILE @run > 0
    BEGIN
        DECLARE @runPType VARCHAR(100) = (SELECT PTypeName FROM tempProduct WHERE RowID = @run)
        DECLARE @runApp VARCHAR(100) = (SELECT AppVersion FROM tempProduct WHERE RowID = @run)
        DECLARE @runEng VARCHAR(100) = (SELECT EngVersion FROM tempProduct WHERE RowID = @run)
        DECLARE @runAvSig VARCHAR(100) = (SELECT AvSigVersion FROM tempProduct WHERE RowID = @run)
        DECLARE @runAvState VARCHAR(100) = (SELECT AvStateID FROM tempProduct WHERE RowID = @run)
        EXEC yz273_pInsertProduct
            @newTypeName = @runPType,
            @EngVersion = @runEng,
            @AppVersion = @runApp,
            @AvSigVersion = @runAvSig,
            @AvStateID = @runAvState
        -- finished inserting the row, delete from temp table and indent run
        DELETE FROM tempProduct WHERE RowID = @run
        SET @run = @run - 1
    end

TRUNCATE TABLE Product


-- -- TRUNCATE TABLE Product
-- INSERT INTO Product (PTypeID, AppVersion, EngVersion, AvSigVersion, AvStateID)
-- SELECT (CASE
--         WHEN ProductName = 'fep' THEN 1
--             WHEN ProductName = 'mse' THEN 2
--             WHEN ProductName = 'mseprerelease' THEN 3
--             WHEN ProductName = 'scep' THEN 4
--             WHEN ProductName = 'win8defender' THEN 5
--             ELSE 6 END) AS PTypeID, AppVersion, EngineVersion, AvSigVersion, AVProductStatesIdentifier
--        FROM tblWorkingCopy

SELECT ((SELECT COUNT(*) FROM tempMacProd) + (SELECT COUNT(*) FROM Machine_Prod))