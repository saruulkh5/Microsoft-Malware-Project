/******
  Table: Machine_Product
  Related look up: Product, Machine
  Related columns:
    - Product: EngVersion, AppVersion, AvSigVersion, AvStateID
    - Machine:
  ******/

CREATE -- ALTER
    PROC yz273_pGetProductID
@PTypeName VARCHAR(100),
@EngVersion VARCHAR(100),
@AppVersion VARCHAR(100),
@AvSigVersion VARCHAR(100),
@AvStateID VARCHAR(100),
@ProductID INT OUTPUT
AS
    BEGIN
        DECLARE @PTypeID INT = (SELECT (
            CASE WHEN @PTypeName = 'fep' THEN 1
            WHEN @PTypeName = 'mse' THEN 2
            WHEN @PTypeName = 'mseprerelease' THEN 3
            WHEN @PTypeName = 'scep' THEN 4
            WHEN @PTypeName = 'win8defender' THEN 5
            ELSE 6 END
        ))
    SET @ProductID = (
        SELECT ProdID FROM Product
        WHERE PTypeID = @PTypeID
        AND EngVersion = @EngVersion
        AND AppVersion = @AppVersion
        AND AvSigVersion = @AvSigVersion
        AND AvStateID = @AvStateID
        )
    end
GO

-- Creates temp and run table for insert
-- DROP TABLE tempMacProd
/*CREATE TABLE tempMacProd (
    RowID INT IDENTITY PRIMARY KEY ,
    PTypeName VARCHAR(100),
    EngVersion VARCHAR(100),
    AppVersion VARCHAR(100),
    AvSigVersion VARCHAR(100),
    AvStateID VARCHAR(100),
    MachineTag VARCHAR(100)
)
INSERT INTO tempMacProd (PTypeName, EngVersion, AppVersion, AvSigVersion, AvStateID, MachineTag)
SELECT ProductName, EngineVersion, AppVersion, AvSigVersion, AVProductStatesIdentifier, MachineIdentifier
FROM tblWorkingCopy*/

GO
USE Malware_Project
GO
CREATE -- ALTER
    PROC yz273_pInsertMacProd
@newPType VARCHAR(100),
@newEngVersion VARCHAR(100),
@newAppVersion VARCHAR(100),
@newAvSigVersion VARCHAR(100),
@newAvStateID VARCHAR(100),
@newMachineTag VARCHAR(100)
AS
    BEGIN
        DECLARE @MID INT, @PID INT
        EXEC yz273_pGetProductID
            @PTypeName = @newPType,
            @EngVersion = @newEngVersion,
            @AppVersion = @newAppVersion,
            @AvSigVersion = @newAvSigVersion,
            @AvStateID = @newAvStateID,
            @ProductID = @PID OUTPUT
        EXEC yz273_pGetMachineID
            @MachineTag = @newMachineTag,
            @MachineID = @MID OUTPUT
        INSERT INTO Machine_Prod (MachineID, ProdID)
        VALUES (@MID, @PID)
    end
GO

GO
CREATE -- ALTER
    PROC yz273_pWrapperMacProd
@run INT
AS
    WHILE @run > 0
    BEGIN
        DECLARE @runPType VARCHAR(100) = (SELECT PTypeName FROM tempMacProd WHERE RowID = @run),
            @runEng VARCHAR(100) = (SELECT EngVersion FROM tempMacProd WHERE RowID = @run),
            @runApp VARCHAR(100) = (SELECT AppVersion FROM tempMacProd WHERE RowID = @run),
            @runAvSig VARCHAR(100) = (SELECT AvSigVersion FROM tempMacProd WHERE RowID = @run),
            @runAvState VARCHAR(100) = (SELECT AvStateID FROM tempMacProd WHERE RowID = @run),
            @runMachineTag VARCHAR(100) = (SELECT MachineTag FROM tempMacProd WHERE RowID = @run)
        EXEC yz273_pInsertMacProd
            @newPType = @runPType,
            @newEngVersion = @runEng,
            @newAppVersion = @runApp,
            @newAvSigVersion = @runAvSig,
            @newAvStateID = @runAvState,
            @newMachineTag = @runMachineTag
        DELETE FROM tempMacProd WHERE RowID = @run
        SET @run = @run - 1
    end
GO

    /* Execute this section if an error occur */
TRUNCATE TABLE Machine_Prod -- truncate actual table
TRUNCATE TABLE tempMacProd -- truncate working copy for Machine_Prod
INSERT INTO tempMacProd (PTypeName, EngVersion, AppVersion, AvSigVersion, AvStateID, MachineTag)
SELECT ProductName, EngineVersion, AppVersion, AvSigVersion, AVProductStatesIdentifier, MachineIdentifier FROM tblWorkingCopy
GO -- Reset the table;
    -- Loop
DECLARE @runMacProd INT = (SELECT COUNT(*) FROM tempMacProd)
EXEC yz273_pWrapperMacProd
@run = @runMacProd
GO

/* Create Procedure to debug MacProd disconnection */
CREATE -- ALTER
PROC yz273_debugMacProd
AS BEGIN
    DECLARE @dePT VARCHAR(100),
        @deApp VARCHAR(100),
        @deEng VARCHAR(100),
        @deSig VARCHAR(100),
        @deState VARCHAR(100),
        @deMachine VARCHAR(100)
    SELECT @dePT = PTypeName,
           @deApp = AppVersion,
           @deEng = EngVersion,
           @deSig = AvSigVersion,
           @deState = AvStateID,
           @deMachine = MachineTag
    FROM tempMacProd
    WHERE RowID = (SELECT MAX(RowID) FROM tempMacProd)
    DECLARE @tempTopProdID INT
    DECLARE @tempTopMacID INT
    DECLARE @topProdID INT
    DECLARE @topMacID INT
    EXEC yz273_pGetProductID
        @PTypeName = @dePT,
        @EngVersion = @deEng,
        @AppVersion = @deApp,
        @AvSigVersion = @deSig,
        @AvStateID = @deState,
        @ProductID = @tempTopProdID OUTPUT
    EXEC yz273_pGetMachineID
        @MachineTag = @deMachine,
        @MachineID = @tempTopMacID OUTPUT
    SELECT @topProdID = ProdID,
           @topMacID = MachineID
    FROM Machine_Prod
    WHERE MachineProdID = (SELECT MAX(MachineProdID) FROM Machine_Prod)
    IF @topMacID = @tempTopMacID AND @topProdID = @tempTopProdID
        SELECT 'Delete last row from tempMacProd and then restart the procedure'
    ELSE
        SELECT 'Directly restart the procedure'
    END
GO