/**
  Makes a procedure to check ratios of locations
  **/
-- Creating the tables
    -- see remaking below
-- remaking tables if necessary:
/*create table Location_Test (
    LocTestID int identity primary key ,
    TotalElements int,
    NumberDetections int,
    Ratio numeric(7,2)
)
create table Location_Test_Combination (
    LocCombID int identity primary key ,
    LocTestID int foreign key references Location_Test (LocTestID),
    EntityName varchar(50),
    VariableName varchar(100),
    VariableValue varchar(100),
)*/

-- Draft:
/*declare @totalLocation int = (select count(*) from Location)
print @totalLocation

GO
-- Procedure created
create -- alter
    proc pTestLocation_Setting
    @locationID int,
    @settingName varchar(100),
    @value varchar(100)
as begin
    declare @malwareID int = 709911
    declare @totalCriteria int,
        @infected int;
    with cte_loc_setting as (
        select m.MachineID, MS.SettingID from Machine m
            join Machine_Setting MS on m.MachineID = MS.MachineID
            join Setting S on MS.SettingID = S.SettingID
            join Setting_Type ST on S.SettingTypeID = ST.SettingTypeID
            where m.LocationID = @locationID
            and s.SettingName = @value
            and ST.SettingTypeName = @settingName
    ) select @totalCriteria = count(*),
             @infected = (
                 select count(*)
                 from cte_loc_setting
                 where SettingID = @malwareID
                 )
    if @totalCriteria > 0 begin
        declare @result int = (
            100 * @infected / @totalCriteria
            )
        insert into Location_Test (TotalElements, NumberDetections, Ration)
        values(@totalCriteria, @infected, @result)
        declare @maxID int = (select max(LocTestID) from Location_Test)
        insert into Test_Comb_Loc (LocTestID, VariableValue, VariableName)
        values (@maxID, @locationID, 'LocationID'),
               (@maxID, @value, @settingName)
        end
    else print 'No observation found with the criteria'
end*/

/*create table indexedFullDataOfInterest (
    RowID int identity primary key,
    SettingTypeName varchar(100),
    SettingName varchar(100),
    Frequency numeric(7,2),
    DetectedPercent numeric(7,2),
    TableName varchar(100)
)*/

/*create table Location_Of_Interest (
    RowID int identity primary key ,
    LocationID int foreign key references Location(LocationID)
)*/
/*insert into Location_Of_Interest (LocationID)
select LocationID from Location l
join Region R2 on l.RegionID = R2.RegionID
join Country C on l.CountryID = C.CountryID
join GeoLocation GL on l.GeoID = GL.GeoID
where GL.GeoCode = '158'*/

-- Population loop
/*while (select count(*) from tempLocation) > 0 begin
    declare @minPK int = (select min(RowID) from tempLocation)
    declare @table varchar(100) = (select TableName from tempLocation where RowID = @minPK)
    if @table = 'City' begin
        declare @newCityCode varchar(100) = (select SettingName from tempLocation where RowID = @minPK)
        insert into Location_Of_Interest (LocationID)
        select LocationID from Location where CityCode = @newCityCode
    end
    if @table = 'Region' begin
        declare @newRegionCode varchar(100) = (select SettingName from tempLocation where RowID = @minPK)
        insert into Location_Of_Interest (LocationID)
        select LocationID from Location l
        join Region R3 on l.RegionID = R3.RegionID
        where R3.RegionCode = @newRegionCode
    end
    if @table = 'Country' begin
        declare @newCountryCode varchar(100) = (select SettingName from tempLocation where RowID = @minPK)
        insert into Location_Of_Interest (LocationID)
        select LocationID from Location l
        join Country C2 on l.CountryID = C2.CountryID
        where C2.CountryCode = @newCountryCode
    end
    if @table = 'GeoLocation' begin
        declare @newGeoCode varchar(100) = (select SettingName from tempLocation where RowID = @minPK)
        insert into Location_Of_Interest (LocationID)
        select LocationID from Location l
        join GeoLocation G on l.GeoID = G.GeoID
        where G.GeoCode = @newGeoCode
    end
    delete from tempLocation where RowID = @minPK
end
*/
-- select * from QueryAgainst

-- execution reference table:
    -- Location_Of_Interest (LocationID)
    -- Entity_Of_Interest (Entity, EntityFieldName, EntityValue)
        -- the entity here refers to the TableName in QueryAgainst
/*create table Entity_Of_Interest (
    EntityID int identity primary key ,
    Entity varchar(100), -- describes what big entity the entry is
    EntityFieldName varchar(100),
    EntityValue varchar(100)
)*/
/*insert into Entity_Of_Interest (Entity, EntityFieldName, EntityValue)
select TableName, SettingTypeName, SettingName
from QueryAgainst*/
select * from Entity_Of_Interest
select * from Location_Of_Interest

/*
    -- develop a loop
for each location in location of interest,
    query and record the infection rate against each entry in entity of interest
    entity entry information put in Location_Test_Combination
*/
-- create table LocationQuery (
    -- this table is used for storing temporary machine entities for counting;
--     RowID int identity primary key ,
--     MachineID int not null
-- )
declare @malwareID int = 709911
declare @locationIndex int = 1
while @locationIndex <= (select max(RowID) from Location_Of_Interest) begin
    declare @newLocationID int = (select LocationID from Location_Of_Interest where RowID = @locationIndex)
    -- insert all machines that meet the criteria;
    -- Census_PrimaryDiskTotalCapacity,500786
    insert into LocationQuery (MachineID)
    select m.MachineID
    from Machine m
    join tblWorkingCopy w on m.MachineTag = w.MachineIdentifier
    join Location L on m.LocationID = L.LocationID
    where w.Census_PrimaryDiskTotalCapacity = '500786'
    and L.LocationID = @newLocationID
    declare @totalCriteria int = (select count(*) from LocationQuery)
    truncate table LocationQuery
    if @totalCriteria != 0 begin
        insert into LocationQuery (MachineID)
        select m.MachineID
        from Machine m
        join Machine_Setting ms on m.MachineID = ms.MachineID
        join tblWorkingCopy w on m.MachineTag = w.MachineIdentifier
        join Location L on m.LocationID = L.LocationID
        where w.Census_PrimaryDiskTotalCapacity = '500786'
        and L.LocationID = @newLocationID
        and ms.SettingID = @malwareID
        declare @infected int = (
            select count(*) from (
                                 select distinct MachineID from LocationQuery
                                     ) as temp1
            )
        truncate table LocationQuery
        declare @ratio numeric(7,2) = @infected / @totalCriteria * 100
        -- insert into test tables;
        insert into Location_Test (TotalElements, NumberDetections, Ratio)
        values (@totalCriteria, @infected, @ratio)

        declare @maxTestID int = (select max(LocTestID) from Location_Test)
        insert into Location_Test_Combination (LocTestID, EntityName, VariableName, VariableValue)
        values (@maxTestID, 'DiskSize', 'Primary Total Capacity', '500786')
        insert into Location_Test_Combination (LocTestID, EntityName, VariableName, VariableValue)
        values (@maxTestID, 'Location', 'LocationID', @newLocationID)
    end
    else print 'no machine meets the criteria'
    set @locationIndex = @locationIndex + 1
end
go


select * from LocationQuery

/*create procedure pCheckLocationTest
    as begin
        select * from Location_Test
        join Location_Test_Combination LTC on Location_Test.LocTestID = LTC.LocTestID
    end*/
exec pCheckLocationTest
go
-- amount after Display: 39/70
select count(*) from Location_Test_Combination


/* below is the structure of the querying,
       entities coming up:
            Display
            Firmware (needs to confirm)
            Not in ERD: Census_PrimaryDiskTotalCapacity,500786
            Organization: OrganizationIdentifier,50
            Processor
            Product
            Setting
            SystemVolume
       */
-- testing:
select m.MachineID
        from Machine m
        join Firmware F on m.FirmwareID = F.FirmwareID
        join Location L on m.LocationID = L.LocationID
        where F.FirmVerID = '69529'
        and L.LocationID = 255483
-- note field
-- Census_PrimaryDiskTotalCapacity,500786
-- OrganizationIdentifier,50

-- Single value looping:
declare @malwareID int = 709911
declare @locationIndex int = 1
while @locationIndex <= (select max(RowID) from Location_Of_Interest) begin
    declare @newLocationID int = (select LocationID from Location_Of_Interest where RowID = @locationIndex)
    -- insert all machines that meet the criteria;

    insert into LocationQuery (MachineID)
    select m.MachineID
    from Machine m
    join Organization o on m.OrgID = o.OrgID
    join Location L on m.LocationID = L.LocationID
    where o.OrgTag = '50'
    and L.LocationID = @newLocationID

    declare @totalCriteria int = (select count(*) from LocationQuery)
    truncate table LocationQuery
    if @totalCriteria != 0 begin

        insert into LocationQuery (MachineID)
        select m.MachineID
        from Machine m
        join Machine_Setting ms on m.MachineID = ms.MachineID
        join Organization o on m.OrgID = o.OrgID
        join Location L on m.LocationID = L.LocationID
        where o.OrgTag = '50'
        and L.LocationID = @newLocationID
        and ms.SettingID = @malwareID

        declare @infected int = (
            select count(*) from (
                                 select distinct MachineID from LocationQuery
                                     ) as temp1
            )
        truncate table LocationQuery
        declare @ratio numeric(7,2) = @infected / @totalCriteria * 100
        -- insert into test tables;
        insert into Location_Test (TotalElements, NumberDetections, Ratio)
        values (@totalCriteria, @infected, @ratio)

        declare @maxTestID int = (select max(LocTestID) from Location_Test)
        insert into Location_Test_Combination (LocTestID, EntityName, VariableName, VariableValue)
        values (@maxTestID, 'DiskSize', 'Primary Total Capacity', '500786')
        insert into Location_Test_Combination (LocTestID, EntityName, VariableName, VariableValue)
        values (@maxTestID, 'Location', 'LocationID', @newLocationID)
    end
    else print 'no machine meets the criteria'
    set @locationIndex = @locationIndex + 1
end
go

-- inner loop
declare @malwareID int = 709911
declare @locationIndex int = 1
while @locationIndex <= (select max(RowID) from Location_Of_Interest) begin
    declare @newLocationID int = (select LocationID from Location_Of_Interest where RowID = @locationIndex)
    -- insert all machines that meet the criteria;
    declare @innerIndexID int
    while (select count(*) from FirmwareOfInterest) > 0 begin
        set @innerIndexID = (select min(EntityID) from FirmwareOfInterest)
        declare @newFirmVerID varchar(100) = (select EntityValue from FirmwareOfInterest where EntityID = @innerIndexID)
        -- query used to extract all machines meeting criteria;
        insert into LocationQuery (MachineID)
        select m.MachineID
        from Machine m
        join Firmware F on m.FirmwareID = F.FirmwareID
        join Location L on m.LocationID = L.LocationID
        where F.FirmVerID = @newFirmVerID
        and L.LocationID = @newLocationID

        declare @totalCriteria int = (select count(*) from LocationQuery)
        truncate table LocationQuery
        if @totalCriteria != 0 begin
            insert into LocationQuery (MachineID)
            select m.MachineID
            from Machine m
            join Machine_Setting ms on m.MachineID = ms.MachineID
            join Firmware F on m.FirmwareID = F.FirmwareID
            join Location L on m.LocationID = L.LocationID
            where F.FirmVerID = @newFirmVerID
            and L.LocationID = @newLocationID
            and ms.SettingID = @malwareID
            declare @infected int = (
                select count(*) from (
                                     select distinct MachineID from LocationQuery
                                         ) as temp1
                )
            truncate table LocationQuery
            declare @ratio numeric(7,2) = @infected / @totalCriteria * 100
            -- insert into test tables;
            insert into Location_Test (TotalElements, NumberDetections, Ratio)
            values (@totalCriteria, @infected, @ratio)

            declare @maxTestID int = (select max(LocTestID) from Location_Test)
            insert into Location_Test_Combination (LocTestID, EntityName, VariableName, VariableValue)
            values (@maxTestID, 'Display', 'DiagonalSize', '28.8')
            insert into Location_Test_Combination (LocTestID, EntityName, VariableName, VariableValue)
            values (@maxTestID, 'Location', 'LocationID', @newLocationID)
        end
        else print 'no machine meets the criteria'
        delete from FirmwareOfInterest where EntityID = @innerIndexID
    end
    set @locationIndex = @locationIndex + 1
end
go

/*-- check if Census_PrimaryDiskTotalCapacity has anything;
create table uncategorized ( -- used for storing Census_PrimaryDiskTotalCapacity
    RowID int identity primary key ,
    MachineID int foreign key references Machine(MachineID),
    Capacity varchar(100)
)
-- truncate table uncategorized
insert into uncategorized (MachineID, Capacity)
select distinct m.MachineID, w.Census_PrimaryDiskTotalCapacity
from Machine m
join tblWorkingCopy w on m.MachineTag = w.MachineIdentifier
where w.Census_PrimaryDiskTotalCapacity = '500786'
select count(*) from uncategorized
drop table uncategorized
declare @locationIndex int = 1
while @locationIndex <= (select max(RowID) from Location_Of_Interest) begin
    declare @newLocationID int = (select LocationID from Location_Of_Interest where RowID = @locationIndex)
    -- insert all machines that meet the criteria;
    declare @count int = (select count(*) from (
                                 select m.MachineID
                                    from Machine m
                                    join Location L on m.LocationID = L.LocationID
                                    join uncategorized u on m.MachineID = u.MachineID
                                    where u.Capacity = '500786'
                                    and L.LocationID = @newLocationID
                                     ) as temp1)
    print @count
    set @locationIndex = @locationIndex + 1
end

select * from LocationQuery*/

select * from SettingOfInterest