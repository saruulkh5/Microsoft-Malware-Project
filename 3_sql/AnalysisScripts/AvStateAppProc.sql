Alter Procedure RunTestAvStateApp
@AvStateID varchar(50),
@AppVersion varchar(50)
AS

Declare @MalwareID INT = (Select S.SettingID FROM Setting S
							JOIN Setting_Type ST on S.SettingTypeID = ST.SettingTypeID
							Where S.SettingName = '1' AND ST.SettingTypeName = 'hasDetections')

Insert Into Machine_Product_Lite (MachineID, ProdID)
Select MP.MachineID, MP.ProdID
From Product P
	Join Machine_Prod MP on P.ProdID = MP.ProdID
Where P.AvStateID = @AvStateID AND P.AppVersion = @AppVersion

Declare @Count1 INT
Set @Count1 = (Select Count(*) From Machine_Product_Lite)

Insert Into Machine_Product_Lite (MachineID, ProdID)
Select MP.MachineID, MP.ProdID
From Product P
	Join Machine_Prod MP on P.ProdID = MP.ProdID
	Join Machine M on MP.MachineID = M.MachineID
	Join Machine_Setting MS on M.MachineID = MS.MachineID
Where MS.SettingID = @MalwareID


Declare @Count2 Numeric(7,2), 
		@Result Numeric(7,2)

/*Get Count & Results*/
If (@Count1 > 0)
	Begin
	/*Get count of all machines that have the desired product and have the hasDetection setting*/
		Set @Count2 = (
			Select Count(Distinct MP.MachineID) AS Count2
			FROM Product P
			Join Machine_Product_Lite MP on P.ProdID = MP.ProdID
			Join (Select MP2.MachineID From Machine_Product_Lite MP2
						Join Machine M2 on MP2.MachineID = M2.MachineID
						Join Machine_Setting MS2 on M2.MachineID = MS2.MachineID
						Where MS2.SettingID = @MalwareID) as MalwareSetting on MP.MachineID = MalwareSetting.MachineID
				Where P.AvStateID = @AvStateID AND P.AppVersion = @AppVersion)

		Set @Result = (100 * @Count2/@Count1)
	End
Else
	Begin
		Set @Count2 = 0
		Set @Result = 0
	End

/*Fill-In Test Data*/
Begin Transaction T2

/*Alter Temp_Test to Test*/
INSERT INTO Test (
    TotalElements,
    NumberOfDetections,
    Ratio
)
Values (
    @Count1,
    @Count2,
    @Result
)

/*Alter Temp_Test to Test*/
Declare @TestID INT = (SELECT MAX(TestID) From Test)

Insert Into Test_Combination (TestID, VariableName, TypeDescription)
Values (@TestID, @AvStateID, 'AvStateID'), (@TestID, @AppVersion, 'AppVersion')

Truncate Table Machine_Product_Lite

COMMIT TRANSACTION T2
GO

Exec RunTestAvStateApp '63682', '4.8.10240.17946'

/*
Result:
Select * from Test Where TestID = 1135
Select * From Test_Combination
*/