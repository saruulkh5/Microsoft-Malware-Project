USE Malware_Project

CREATE TABLE Test_SettingProduct(
TestSettingProductID int primary key identity(1,1) not null,
TestID int foreign key references Test(TestID),
SettingName varchar(100) not null,
SettingType varchar(100) not null,
ProductName varchar(100) not null,
ProductType varchar(100) not null)

CREATE PROCEDURE runOneProductOneSetting
@SettingName varchar(100),
@SettingType varchar(100),
@ProductName varchar(100),
@ProductType varchar(100)
AS

Declare @Count1 Numeric(7,2), 
		@Count2 Numeric(7,2), 
		@Result Numeric(7,2)

SET @Count1 = (SELECT COUNT(MS.MachineID) FROM Machine_Setting MS 
JOIN Setting S ON MS.SettingID = S.SettingID
JOIN Setting_Type ST ON S.SettingTypeID = ST.SettingTypeID
JOIN Machine_Prod MP ON MS.MachineID = MP.MachineID
JOIN Product P ON MP.ProdID = P.ProdID
WHERE S.SettingName = @SettingName AND ST.SettingTypeName = @SettingType
AND @ProductName =
	CASE @ProductType
	WHEN 'AppVersion' THEN P.AppVersion
	WHEN 'AvSigVersion' THEN P.AvSigVersion
	WHEN 'AvStateID' THEN P.AvStateID
END)

IF (@Count1 > 0) 
	BEGIN
		SET @count2 = (SELECT COUNT(SQ1.MachineID) as Total FROM
		(SELECT MS.MachineID FROM Machine_Setting MS 
		JOIN Setting S ON MS.SettingID = S.SettingID
		JOIN Setting_Type ST ON S.SettingTypeID = ST.SettingTypeID
		JOIN Machine_Prod MP ON MS.MachineID = MP.MachineID
		JOIN Product P ON MP.ProdID = P.ProdID
		WHERE S.SettingName = @SettingName AND ST.SettingTypeName = @SettingType
		AND @ProductName =
			CASE @ProductType
			WHEN 'AppVersion' THEN P.AppVersion
			WHEN 'AvSigVersion' THEN P.AvSigVersion
			WHEN 'AvStateID' THEN P.AvStateID
		END) SQ1 
		JOIN
		(SELECT MS.MachineID FROM Machine_Setting MS 
		WHERE MS.SettingID = 709911) SQ2 ON SQ1.MachineID = SQ2.MachineID)
		Set @Result = (100 * @Count2/@Count1)
	END
ELSE
	BEGIN
		SET @Count2 = 0
		SET @Result = 0
	END

Begin Transaction T2

INSERT INTO Test (TotalElements, NumberOfDetections, Ratio)
Values (@Count1, @Count2, @Result)

Declare @TestID INT = (SELECT MAX(TestID) From Test)

INSERT INTO Test_SettingProduct(TestID, SettingName, SettingType, ProductName, ProductType)
Values (@TestID, @SettingName, @SettingType, @ProductName, @ProductType)

COMMIT TRANSACTION T2
GO

EXEC runOneProductOneSetting
    @SettingName = 'ExistsNotSet',
    @SettingType  = 'SmartScreen',
    @ProductName  = '63682',
    @ProductType  = 'AvStateID'

/*
Result:
SELECT * FROM Test T
JOIN Test_SettingProduct TSP ON T.TestID = TSP.TestID
*/
