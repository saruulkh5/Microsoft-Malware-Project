Alter Procedure RunRatioTest2Combination
@SettingName1 varchar(100), 
@SettingType1 varchar(100),
@SettingName2 varchar(100),
@SettingType2 varchar(100)

AS

/*Declare Additional Fields*/
Declare @SettingID1 INT, 
		@SettingID2 INT, 
		@MalwareID INT

/*Set Additional Fields*/
Set @SettingID1 = (Select SettingID FROM Setting S
					JOIN Setting_Type ST on S.SettingTypeID = ST.SettingTypeID
					Where S.SettingName = @SettingName1 AND ST.SettingTypeName = @SettingType1)

Set @SettingID2 = (Select SettingID FROM Setting S
					JOIN Setting_Type ST on S.SettingTypeID = ST.SettingTypeID
					Where S.SettingName = @SettingName2 AND ST.SettingTypeName = @SettingType2)

Set @MalwareID = (Select SettingID FROM Setting S
					JOIN Setting_Type ST on S.SettingTypeID = ST.SettingTypeID
					Where S.SettingName = '1' AND ST.SettingTypeName = 'hasDetections')

/*Fill Machine_Setting_Lite With Relevant Data*/
Begin Transaction T1
s
Insert Into Machine_Setting_Lite (MachineID, SettingID)
Select MS.MachineID, MS.SettingID FROM Machine_Setting MS
Where MS.SettingID = @SettingID1

Insert Into Machine_Setting_Lite (MachineID, SettingID)
Select MS.MachineID, MS.SettingID FROM Machine_Setting MS
Where MS.SettingID = @SettingID2

Insert Into Machine_Setting_Lite (MachineID, SettingID)
Select MS.MachineID, MS.SettingID FROM Machine_Setting MS
Where MS.SettingID = @MalwareID

Commit Transaction T1

Declare @Count1 Numeric(7,2), 
		@Count2 Numeric(7,2), 
		@Result Numeric(7,2)

/*Find Counts and Result*/
/*Find Count of all machines with the specific setting*/
Set @Count1 = (
	Select Count(MS.MachineID) AS Count1
	FROM Machine_Setting_Lite MS
	JOIN (SELECT MS2.MachineID FROM Machine_Setting_Lite MS2
			Where MS2.SettingID = @SettingID2) AS TestSetting2 on MS.MachineID = TestSetting2.MachineID
	Where MS.SettingID = @SettingID1)

If (@Count1 > 0)
	Begin
	/*Find Count of all machines with specific settings and hasDetection*/
		Set @Count2 = (
			Select Count(MS.MachineID) AS Count2
			FROM Machine_Setting_Lite MS
			JOIN (SELECT MS2.MachineID FROM Machine_Setting_Lite MS2
					Where MS2.SettingID = @MalwareID) AS HasDetections on MS.MachineID = HasDetections.MachineID
			JOIN (SELECT MS3.MachineID FROM Machine_Setting_Lite MS3 
					Where MS3.SettingID = @SettingID2) AS TestSetting2 on MS.MachineID = TestSetting2.MachineID
			Where MS.SettingID = @SettingID1)
	
		Set @Result = (100 * @Count2/@Count1)
	End
Else
	Begin
		Set @Count2 = 0
		Set @Result = 0
	End

/*Fill-In Test Data*/
Begin Transaction T2

INSERT INTO Test (
    TotalElements,
    NumberOfDetections,
    Ratio
)
Values (
    @Count1,
    @Count2,
    @Result
)

Declare @TestID INT = (SELECT MAX(TestID) From Test)

Insert Into Test_Setting (SettingID, TestID, TypeDescription)
Values (@SettingID1, @TestID, 'Setting'), (@SettingID2, @TestID, 'Setting')

Truncate Table Machine_Setting_Lite

COMMIT TRANSACTION T2
GO

/*Execute Stored Procedure*/

EXEC RunRatioTest2Combination
    '10586.494.amd64fre.th2_release_sec.160630-1736',
    'OSBuildLab',
    '262',
    'LocaleEnglishNameIdentifier'


Select * from Test
Select * From Test_Setting


/* Don't run any code below this point */

/*
    Truncate Table Test
    Truncate Table Test_Setting
*/