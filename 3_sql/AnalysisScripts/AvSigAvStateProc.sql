Create Procedure RunTestAvStateAvSig
@AvStateID varchar(50),
@AvSigVersion varchar(50)
AS

Declare @MalwareID INT = (Select S.SettingID FROM Setting S
							JOIN Setting_Type ST on S.SettingTypeID = ST.SettingTypeID
							Where S.SettingName = '1' AND ST.SettingTypeName = 'hasDetections')

Insert Into Machine_Product_Lite (MachineID, ProdID)
Select MP.MachineID, MP.ProdID
From Product P
	Join Machine_Prod MP on P.ProdID = MP.ProdID
Where P.AvStateID = @AvStateID AND AvSigVersion = @AvSigVersion

Declare @Count1 INT
Set @Count1 = (Select Count(*) From Machine_Product_Lite)

Insert Into Machine_Product_Lite (MachineID, ProdID)
Select MP.MachineID, MP.ProdID
From Product P
	Join Machine_Prod MP on P.ProdID = MP.ProdID
	Join Machine M on MP.MachineID = M.MachineID
	Join Machine_Setting MS on M.MachineID = MS.MachineID
Where MS.SettingID = @MalwareID


Declare @Count2 Numeric(7,2), 
		@Result Numeric(7,2)

/*Get Count & Results*/
If (@Count1 > 0)
	Begin
	/*Get count of all machines that have the desired product and have the hasDetection setting*/
		Set @Count2 = (
			Select Count(MP.MachineID) AS Count2
			FROM Product P
			Join Machine_Product_Lite MP on P.ProdID = MP.ProdID
			Join (Select MP2.MachineID From Machine_Product_Lite MP2
						Join Machine M2 on MP2.MachineID = M2.MachineID
						Join Machine_Setting MS2 on M2.MachineID = MS2.MachineID
						Where MS2.SettingID = @MalwareID) as MalwareSetting on MP.MachineID = MalwareSetting.MachineID
				Where P.AvStateID = @AvStateID AND AvSigVersion = @AvSigVersion)
	
		Set @Result = (100 * @Count2/@Count1)
	End
Else
	Begin
		Set @Count2 = 0
		Set @Result = 0
	End

/*Fill-In Test Data*/
Begin Transaction T2

/*Alter Temp_Test to Test*/
INSERT INTO Temp_Test (
    TotalElements,
    NumberOfDetections,
    Ratio
)
Values (
    @Count1,
    @Count2,
    @Result
)

/*Alter Temp_Test to Test*/
Declare @TestID INT = (SELECT MAX(TestID) From Temp_Test)

Insert Into Test_Combination (TestID, VariableName, TypeDescription)
Values (@TestID, @AvStateID, 'AvStateID'), (@TestID, @AvSigVersion, 'AvSigVersion')

Truncate Table Machine_Product_Lite

COMMIT TRANSACTION T2
GO

/* Execution */
Exec RunTestAvStateAvSig '63682', '1.273.1501.0'

/*
Result:
Select * from Temp_Test
Select * From Test_Combination
*/

/* Don't run any code below this point */ 
/*
Truncate Table Temp_Test
Truncate Table Test_Combination
*/












Create Table Temp_Test (
TestID INT Primary Key Identity(1,1) Not Null,
TotalElements INT Not Null,
NumberOfDetections INT Not Null,
Ratio Numeric(7,2)
)


Create Table Test_Combination (
TestProductID INT Primary Key Identity(1,1) Not Null,
TestID INT Foreign Key References Temp_Test(TestID),
VariableName varchar(100) Not Null,
TypeDescription varchar(100)
)


Drop Table Test_Combination



Declare @AvStateID varchar(50), @AvSigVersion varchar(50)
Set @AvStateID = '63682'
Set @AvSigVersion = '1.273.1501.0'
Declare @MalwareID INT = (Select S.SettingID FROM Setting S
							JOIN Setting_Type ST on S.SettingTypeID = ST.SettingTypeID
							Where S.SettingName = '1' AND ST.SettingTypeName = 'hasDetections')
Declare @Count2 INT
Set @Count2 = (
			Select Count(MP.MachineID) AS Count2
			FROM Product P
			Join Machine_Product_Lite MP on P.ProdID = MP.ProdID
			Join (Select MP2.MachineID From Machine_Product_Lite MP2
						Join Machine M2 on MP2.MachineID = M2.MachineID
						Join Machine_Setting MS2 on M2.MachineID = MS2.MachineID
						Where MS2.SettingID = @MalwareID) as MalwareSetting on MP.MachineID = MalwareSetting.MachineID
				Where P.AvStateID = @AvStateID AND AvSigVersion = @AvSigVersion)
Select @Count2