/**********

  This query file contains the queries we performed on our SQL database
    and derive observations
  Created by: Alex Honeycutt, Andy Cahill
  Modified by: Wayne Zhang
  Created Date: March 8th, 2020

**********/

/*Without hasDetections - Count1*/
Select Count(MS.MachineID) AS Count1
FROM Machine_Setting MS
JOIN Setting S on MS.SettingID = S.SettingID
JOIN Setting_Type ST on S.SettingTypeID = ST.SettingTypeID
JOIN (SELECT MS3.MachineID FROM Setting_Type ST3
			Join Setting S3 on ST3.SettingTypeID = S3.SettingTypeID
			Join Machine_Setting MS3 on S3.SettingID = MS3.SettingID
			WHERE S3.SettingName = '17914' and ST3.SettingTypeName = 'Census_OSBuildRevision') AS Census_OSBuildRevision on MS.MachineID = Census_OSBuildRevision.MachineID
Where S.SettingName = '10.0.10240.17914' AND ST.SettingTypeName = 'Census_OSVersion'

/*With hasDetections - Count2*/
Select Count(MS.MachineID) AS Count2
FROM Machine_Setting MS
JOIN Setting S on MS.SettingID = S.SettingID
JOIN Setting_Type ST on S.SettingTypeID = ST.SettingTypeID
JOIN (SELECT MS2.MachineID FROM Setting_Type ST2
			Join Setting S2 on ST2.SettingTypeID = S2.SettingTypeID
			Join Machine_Setting MS2 on S2.SettingID = MS2.SettingID
			WHERE S2.SettingName = '1' AND ST2.SettingTypeName = 'hasDetections') AS HasDetections on MS.MachineID = HasDetections.MachineID
JOIN (SELECT MS3.MachineID FROM Setting_Type ST3
			Join Setting S3 on ST3.SettingTypeID = S3.SettingTypeID
			Join Machine_Setting MS3 on S3.SettingID = MS3.SettingID
			WHERE S3.SettingName = '17914' and ST3.SettingTypeName = 'Census_OSBuildRevision') AS Census_OSBuildRevision on MS.MachineID = Census_OSBuildRevision.MachineID
Where S.SettingName = '10.0.10240.17914' AND ST.SettingTypeName = 'Census_OSVersion'

/*
(Count2 / Count1) * 100 = Frequency
*/

/*
To add more settings to be checked, append this join to the other ones
For [Number], change it to be one number higher than the last number in your join clause
For [Change Me Setting Name], change it to be your desired Setting Name
For [Change Me Setting Type], change it to be the related Setting Type
Ensure that this join is added to both the Count1 and Count 2 Queries
*/

JOIN (SELECT MS[Number].MachineID FROM Setting_Type ST[Number]
			Join Setting S[Number] on ST[Number].SettingTypeID = S[Number].SettingTypeID
			Join Machine_Setting MS[Number] on S[Number].SettingID = MS[Number].SettingID
			WHERE S3.SettingName = '[Change Me Setting Name]') AS [Change Me Setting Type] on MS.MachineID = [Change Me Setting Type].MachineID

/*
    Alex
    Steps:
    Create table to store values of interest - Link it to setting and machine
    Fill the table with the values of interest - Can be found in spreadsheet (Include HasDetection)
    Create Stored procedure to create a new view that stores the name and frequency of has detections
    Analyze View
*/
/*
SELECT	(
    (SELECT count(*) FROM NewTable WHERE NewTable.FirmManuTag = '5') /
		count(NewTable.FirmManuTag)) as Col_Frequency
		((SELECT count(*) FROM NewTable WHERE NewTable.SettingName = 'HasDetections'
		and NewTable.FirmManuTag = '5')/(SELECT count(*) FROM NewTable
		WHERE NewTable.SettingName = 'HasDetections')) as Det_Frequency

FROM 		(SELECT count(*)
		FROM tblFirmware F
		JOIN tblMachine M ON M.FirmwareID = F.FirmwareID
		JOIN tblMachine_Setting M ON M.MachineSettingID = MS.MachineSettingID
		JOIN tblSetting S ON S.SettingID = MS.SettingID
		WHERE F.FirmManuTag = '5') as NewTable
*/


Create Table dataOfInterest (
MachineSettingID INT NOT NULL PRIMARY KEY,
MachineID INT Foreign Key References Machine(MachineID),
SettingID INT Foreign Key References Setting(SettingID)
);



Create Procedure FillInterest
@SettingName varchar(50),
@SettingTypeName varchar(50)
AS
Begin Transaction T1
INSERT INTO dataOfInterest (MachineID, SettingID)
Values ((Select M.MachineID, MS.SettingID
		FROM Machine M
		Join Machine_Setting MS on
		M.MachineID = MS.MachineID
		Join Setting S on
		MS.SettingID = S.SettingID
		Join Setting_Type ST on
		S.SettingTypeID = ST.SettingTypeID
		Where S.SettingName = @SettingName
		AND ST.SettingTypeName = @SettingTypeName),
	(Select S.SettingID
		FROM Setting_Type ST
		Join Setting S on
		S.SettingTypeID = ST.SettingTypeID
		Where S.SettingName = @SettingName
		AND ST.SettingTypeName = @SettingTypeName))
END
GO;

EXEC FillInterest @SettingName = '...', @SettingTypeName = '...'

-- Saruul:
-- find ratio by just regular query
CREATE VIEW vProductType AS
SELECT P.PTypeID,
      count(P.ProdID) * 100.0 / (SELECT count(*) FROM Product) AS FrequencyOfType
FROM Product as P
GROUP BY P.PTypeID
GO

-- May 9, Wayne Z, Created two tables proposed by Alex;
CREATE TABLE Test_Setting (
    PrimaryID INT IDENTITY PRIMARY KEY,
    SettingID INT NOT NULL,
    TestID INT
)
CREATE TABLE Test (
    TestID INT IDENTITY PRIMARY KEY,
    TotalElements INT NOT NULL,
    NumberOfDetections INT NOT NULL,
    Ratio NUMERIC(7,2)
)
    -- Meeting with Alex
CREATE TABLE Machine_Setting_Lite (
    RowID INT IDENTITY PRIMARY KEY,
    MachineID INT,
    SettingID INT
)

SELECT * FROM Setting_Type WHERE SettingTypeName LIKE '%Smart%'
SELECT * FROM Setting WHERE SettingTypeID = 20

INSERT INTO Machine_Setting_Lite (MachineID, SettingID)
SELECT ms.MachineID,
FROM Machine_Setting ms
JOIN Setting S on ms.SettingID = S.SettingID
JOIN Setting_Type ST on S.SettingTypeID = ST.SettingTypeID
